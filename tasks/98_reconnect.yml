---
- name: Restart network now (expect brief disconnect)
  ansible.builtin.meta: flush_handlers

- name: Update ansible_host to new mgmt IP
  ansible.builtin.set_fact:
    ansible_host: "{{ openwrt_new_mgmt_ip }}"

- name: Restart network to drop current SSH session (OpenWrt)
  community.openwrt.service:
    name: network
    state: restarted
  ignore_errors: true
  changed_when: true

- name: Verify SSH access with NEW rules
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: "{{ ssh_port }}"
    timeout: 180
    state: started
  delegate_to: localhost
  connection: local
