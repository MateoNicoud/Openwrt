---
# ==========================================
# FIREWALL4 (fw4) - deterministic config
# ==========================================

- name: Firewall - remove legacy anonymous zones that clash with managed names
  ansible.builtin.shell: |
    set -e
    managed="wan mgmt svc guest vpn_admin vpn_ingress"
    for z in $(uci show firewall | sed -n 's/^\(firewall\.\@zone\[[0-9]\+\]\)=zone$/\1/p'); do
      name="$(uci -q get ${z}.name || true)"
      for m in $managed; do
        if [ "$name" = "$m" ]; then
          uci -q delete "$z" || true
        fi
      done
    done
    uci -q commit firewall || true
  args:
    executable: /bin/sh
  changed_when: true

- name: Firewall - remove default forwarding lan->wan (if present)
  ansible.builtin.shell: |
    set -e
    for f in $(uci show firewall | sed -n 's/^\(firewall\.\@forwarding\[[0-9]\+\]\)=forwarding$/\1/p'); do
      src="$(uci -q get ${f}.src || true)"
      dest="$(uci -q get ${f}.dest || true)"
      if [ "$src" = "lan" ] && [ "$dest" = "wan" ]; then
        uci -q delete "$f" || true
      fi
    done
    uci -q commit firewall || true
  args:
    executable: /bin/sh
  changed_when: true

- name: Firewall - remove default WAN allow rules (if present)
  ansible.builtin.shell: |
    set -e
    # Common default rule names shipped by OpenWrt
    names="Allow-DHCP-Renew Allow-Ping Allow-IGMP Allow-DHCPv6 Allow-MLD Allow-ICMPv6-Input Allow-ICMPv6-Forward Allow-IPSec-ESP Allow-ISAKMP"
    for r in $(uci show firewall | sed -n 's/^\(firewall\.\@rule\[[0-9]\+\]\)=rule$/\1/p'); do
      rn="$(uci -q get ${r}.name || true)"
      for n in $names; do
        if [ "$rn" = "$n" ]; then
          uci -q delete "$r" || true
        fi
      done
    done
    uci -q commit firewall || true
  args:
    executable: /bin/sh
  changed_when: true

# -------------------------
# Defaults
# -------------------------
- name: Firewall defaults - ensure section exists
  community.openwrt.uci:
    command: set
    key: "firewall.@defaults[0]"
    value: "defaults"

- name: Firewall defaults - values
  community.openwrt.uci:
    command: set
    key: "firewall.@defaults[0]"
    value:
      input: "REJECT"
      output: "ACCEPT"
      forward: "REJECT"
      syn_flood: "1"

# -------------------------
# WAN zone (named)
# -------------------------
- name: Ensure WAN zone section exists (named)
  community.openwrt.uci:
    command: section
    config: firewall
    type: zone
    name: wan

- name: Configure WAN zone
  community.openwrt.uci:
    command: set
    key: "firewall.wan"
    value:
      name: "wan"
      network: "wan"         # IMPORTANT: no wan6 unless you configure network.wan6
      input: "REJECT"
      output: "ACCEPT"
      forward: "REJECT"
      masq: "1"
      mtu_fix: "1"

# -------------------------
# VLAN zones (named)
# -------------------------
- name: Ensure VLAN zone sections exist (named)
  loop: "{{ vlans }}"
  loop_control:
    label: "{{ item.name }}"
  community.openwrt.uci:
    command: section
    config: firewall
    type: zone
    name: "{{ item.name }}"

- name: Configure VLAN zones
  loop: "{{ vlans }}"
  loop_control:
    label: "{{ item.name }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ item.name }}"
    value:
      name: "{{ item.name }}"
      network: "{{ uci_iface_prefix }}{{ item.id }}"
      input: "{{ item.zone.input }}"
      output: "{{ item.zone.output }}"
      forward: "{{ item.zone.forward }}"

# -------------------------
# Deterministic cleanup (ours)
# -------------------------
- name: Remove deterministic forwardings (vlan->wan)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.fwd_{{ item.name }}_wan"
  ignore_errors: true

- name: Remove deterministic rules (dhcp)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.allow_dhcp_{{ item.name }}"
  ignore_errors: true

- name: Remove deterministic rules (dns)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.allow_dns_{{ item.name }}"
  ignore_errors: true

# -------------------------
# Forwardings VLAN -> WAN (optional)
# -------------------------
- name: Ensure forwardings VLAN -> WAN exist when enabled
  loop: "{{ vlans }}"
  when: allow_outbound_to_wan[item.name] | default(false) | bool
  community.openwrt.uci:
    command: section
    config: firewall
    type: forwarding
    name: "fwd_{{ item.name }}_wan"

- name: Configure forwardings VLAN -> WAN
  loop: "{{ vlans }}"
  when: allow_outbound_to_wan[item.name] | default(false) | bool
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_{{ item.name }}_wan"
    value:
      src: "{{ item.name }}"
      dest: "wan"

# -------------------------
# DHCP/DNS allow to router (rules) for non-mgmt
# -------------------------
- name: Ensure DHCP rule sections exist (named) for non-mgmt
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: section
    config: firewall
    type: rule
    name: "allow_dhcp_{{ item.name }}"

- name: Allow DHCP to router for non-mgmt zones
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: set
    key: "firewall.allow_dhcp_{{ item.name }}"
    value:
      name: "Allow-DHCP-{{ item.name }}"
      src: "{{ item.name }}"
      proto: "udp"
      dest_port: "67-68"
      target: "ACCEPT"

- name: Ensure DNS rule sections exist (named) for non-mgmt
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: section
    config: firewall
    type: rule
    name: "allow_dns_{{ item.name }}"

- name: Allow DNS to router for non-mgmt zones
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: set
    key: "firewall.allow_dns_{{ item.name }}"
    value:
      name: "Allow-DNS-{{ item.name }}"
      src: "{{ item.name }}"
      proto: "tcp udp"
      dest_port: "53"
      target: "ACCEPT"

# -------------------------
# Explicit blocks (rules)
# -------------------------
- name: Ensure rule section exists - block svc->mgmt
  community.openwrt.uci:
    command: section
    config: firewall
    type: rule
    name: "block_svc_to_mgmt"

- name: Explicitly block svc -> mgmt
  community.openwrt.uci:
    command: set
    key: "firewall.block_svc_to_mgmt"
    value:
      name: "Block-SVC-to-MGMT"
      src: "svc"
      dest: "mgmt"
      target: "REJECT"

- name: Ensure rule section exists - block guest->mgmt
  community.openwrt.uci:
    command: section
    config: firewall
    type: rule
    name: "block_guest_to_mgmt"

- name: Explicitly block guest -> mgmt
  community.openwrt.uci:
    command: set
    key: "firewall.block_guest_to_mgmt"
    value:
      name: "Block-GUEST-to-MGMT"
      src: "guest"
      dest: "mgmt"
      target: "REJECT"

# -------------------------
# WireGuard zones / forwardings / ingress rules
# -------------------------
- name: Remove deterministic WG zones (named, ours)
  when: enable_wireguard | bool
  loop: "{{ wg_firewall_zones }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.{{ item.name }}"
  ignore_errors: true

- name: Ensure WG zone sections exist (named)
  when: enable_wireguard | bool
  loop: "{{ wg_firewall_zones }}"
  community.openwrt.uci:
    command: section
    config: firewall
    type: zone
    name: "{{ item.name }}"

- name: Configure Firewall zones for WireGuard
  when: enable_wireguard | bool
  loop: "{{ wg_firewall_zones }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ item.name }}"
    value:
      name: "{{ item.name }}"
      input: "{{ item.input }}"
      output: "{{ item.output }}"
      forward: "{{ item.forward }}"
      network: "{{ item.networks | join(' ') }}"

- name: Remove deterministic WG forwardings (ours)
  when: enable_wireguard | bool
  loop: "{{ wg_forwardings | default([]) }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.fwd_{{ item.src }}_{{ item.dest }}"
  ignore_errors: true

- name: Ensure WG forwarding sections exist (named)
  when: enable_wireguard | bool
  loop: "{{ wg_forwardings | default([]) }}"
  community.openwrt.uci:
    command: section
    config: firewall
    type: forwarding
    name: "fwd_{{ item.src }}_{{ item.dest }}"

- name: Configure WG forwardings
  when: enable_wireguard | bool
  loop: "{{ wg_forwardings | default([]) }}"
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_{{ item.src }}_{{ item.dest }}"
    value:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"

- name: Remove deterministic WG ingress rules (ours)
  when: enable_wireguard | bool
  loop: "{{ wg_ingress_rules | default([]) }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.wg_ingress_{{ item.name | lower | regex_replace('[^a-z0-9]+','_') }}"
  ignore_errors: true

- name: Ensure WG ingress rule sections exist (named)
  when: enable_wireguard | bool
  loop: "{{ wg_ingress_rules | default([]) }}"
  community.openwrt.uci:
    command: section
    config: firewall
    type: rule
    name: "wg_ingress_{{ item.name | lower | regex_replace('[^a-z0-9]+','_') }}"

- name: Configure WG ingress rules (port-only)
  when: enable_wireguard | bool
  loop: "{{ wg_ingress_rules | default([]) }}"
  vars:
    rule_key: "wg_ingress_{{ item.name | lower | regex_replace('[^a-z0-9]+','_') }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ rule_key }}"
    value:
      name: "{{ item.name }}"
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      proto: "{{ item.proto }}"
      dest_port: "{{ item.dest_port }}"
      target: "{{ item.target }}"

# legacy -> mgmt
- name: Allow legacy -> mgmt
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_legacy_mgmt"
    value: "forwarding"
  notify: restart_firewall

- name: Set forwarding legacy -> mgmt
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_legacy_mgmt"
    value:
      src: "legacy"
      dest: "mgmt"
  notify: restart_firewall

# mgmt -> legacy
- name: Allow mgmt -> legacy
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_mgmt_legacy"
    value: "forwarding"
  notify: restart_firewall

- name: Set forwarding mgmt -> legacy
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_mgmt_legacy"
    value:
      src: "mgmt"
      dest: "legacy"
  notify: restart_firewall

# -------------------------
# Validate + Commit
# -------------------------
- name: Commit firewall
  community.openwrt.uci:
    command: commit
    config: firewall
  notify: restart_firewall

- name: Validate fw4 ruleset (fails early if invalid)
  ansible.builtin.command: fw4 check
  changed_when: false
