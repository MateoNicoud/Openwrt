---
- name: Configure firewall defaults (ensure section type)
  community.openwrt.uci:
    command: set
    key: "firewall.@defaults[0]"
    value: "defaults"
  notify: restart_firewall

- name: Configure firewall defaults (values)
  community.openwrt.uci:
    command: set
    key: "firewall.@defaults[0]"
    value:
      input: "REJECT"
      output: "ACCEPT"
      forward: "REJECT"
      syn_flood: "1"
  notify: restart_firewall

# -------------------------
# WAN zone
# -------------------------
- name: Ensure WAN zone section exists (type=zone)
  community.openwrt.uci:
    command: set
    key: "firewall.wan"
    value: "zone"
  notify: restart_firewall

- name: Ensure WAN zone (masq)
  community.openwrt.uci:
    command: set
    key: "firewall.wan"
    value:
      name: "wan"
      network: "wan wan6"
      input: "REJECT"
      output: "ACCEPT"
      forward: "REJECT"
      masq: "1"
      mtu_fix: "1"
  notify: restart_firewall

# -------------------------
# VLAN zones
# -------------------------
- name: Ensure VLAN zone sections exist (type=zone)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ item.name }}"
    value: "zone"
  notify: restart_firewall

- name: Create VLAN zones (mgmt ACCEPT, svc/guest REJECT)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ item.name }}"
    value:
      name: "{{ item.name }}"
      network: "{{ uci_iface_prefix }}{{ item.id }}"
      input: "{{ item.zone.input }}"
      output: "{{ item.zone.output }}"
      forward: "{{ item.zone.forward }}"
  notify: restart_firewall

# -------------------------
# Cleanup deterministic forwardings/rules
# -------------------------
- name: Remove deterministic forwardings (vlan->wan)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.fwd_{{ item.name }}_wan"
  ignore_errors: true
  notify: restart_firewall

- name: Remove deterministic rules (dhcp)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.allow_dhcp_{{ item.name }}"
  ignore_errors: true
  notify: restart_firewall

- name: Remove deterministic rules (dns)
  loop: "{{ vlans }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.allow_dns_{{ item.name }}"
  ignore_errors: true
  notify: restart_firewall

# -------------------------
# Forwardings VLAN -> WAN (optional)
# -------------------------
- name: Ensure forwarding sections exist (type=forwarding) when enabled
  loop: "{{ vlans }}"
  when: allow_outbound_to_wan[item.name] | default(false) | bool
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_{{ item.name }}_wan"
    value: "forwarding"
  notify: restart_firewall

- name: Create forwardings VLAN -> WAN (outbound only)
  loop: "{{ vlans }}"
  when: allow_outbound_to_wan[item.name] | default(false) | bool
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_{{ item.name }}_wan"
    value:
      src: "{{ item.name }}"
      dest: "wan"
  notify: restart_firewall

# -------------------------
# DHCP/DNS allow to router (rules) for non-mgmt
# -------------------------
- name: Ensure DHCP rule sections exist (type=rule) for non-mgmt
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: set
    key: "firewall.allow_dhcp_{{ item.name }}"
    value: "rule"
  notify: restart_firewall

- name: Allow DHCP to router for non-mgmt zones
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: set
    key: "firewall.allow_dhcp_{{ item.name }}"
    value:
      name: "Allow-DHCP-{{ item.name }}"
      src: "{{ item.name }}"
      proto: "udp"
      dest_port: "67-68"
      target: "ACCEPT"
  notify: restart_firewall

- name: Ensure DNS rule sections exist (type=rule) for non-mgmt
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: set
    key: "firewall.allow_dns_{{ item.name }}"
    value: "rule"
  notify: restart_firewall

- name: Allow DNS to router for non-mgmt zones
  loop: "{{ vlans }}"
  when: item.name != "mgmt"
  community.openwrt.uci:
    command: set
    key: "firewall.allow_dns_{{ item.name }}"
    value:
      name: "Allow-DNS-{{ item.name }}"
      src: "{{ item.name }}"
      proto: "tcp udp"
      dest_port: "53"
      target: "ACCEPT"
  notify: restart_firewall

# -------------------------
# Explicit blocks (rules)
# -------------------------
- name: Ensure rule section exists (type=rule) block svc->mgmt
  community.openwrt.uci:
    command: set
    key: "firewall.block_svc_to_mgmt"
    value: "rule"
  notify: restart_firewall

- name: Explicitly block svc -> mgmt (extra safety)
  community.openwrt.uci:
    command: set
    key: "firewall.block_svc_to_mgmt"
    value:
      name: "Block-SVC-to-MGMT"
      src: "svc"
      dest: "mgmt"
      target: "REJECT"
  notify: restart_firewall

- name: Ensure rule section exists (type=rule) block guest->mgmt
  community.openwrt.uci:
    command: set
    key: "firewall.block_guest_to_mgmt"
    value: "rule"
  notify: restart_firewall

- name: Explicitly block guest -> mgmt (extra safety)
  community.openwrt.uci:
    command: set
    key: "firewall.block_guest_to_mgmt"
    value:
      name: "Block-GUEST-to-MGMT"
      src: "guest"
      dest: "mgmt"
      target: "REJECT"
  notify: restart_firewall

# -------------------------
# WireGuard zones / forwardings / ingress rules
# -------------------------
- name: Remove deterministic WG zones
  when: enable_wireguard | bool
  loop: "{{ wg_firewall_zones }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.{{ item.name }}"
  ignore_errors: true
  notify: restart_firewall

- name: Ensure WG zone sections exist (type=zone)
  when: enable_wireguard | bool
  loop: "{{ wg_firewall_zones }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ item.name }}"
    value: "zone"
  notify: restart_firewall

- name: Create Firewall zones for WireGuard (multi)
  when: enable_wireguard | bool
  loop: "{{ wg_firewall_zones }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ item.name }}"
    value:
      name: "{{ item.name }}"
      input: "{{ item.input }}"
      output: "{{ item.output }}"
      forward: "{{ item.forward }}"
      network: "{{ item.networks | join(' ') }}"
  notify: restart_firewall

- name: Remove deterministic WG forwardings
  when: enable_wireguard | bool
  loop: "{{ wg_forwardings | default([]) }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.fwd_{{ item.src }}_{{ item.dest }}"
  ignore_errors: true
  notify: restart_firewall

- name: Ensure WG forwarding sections exist (type=forwarding)
  when: enable_wireguard | bool
  loop: "{{ wg_forwardings | default([]) }}"
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_{{ item.src }}_{{ item.dest }}"
    value: "forwarding"
  notify: restart_firewall

- name: Create WG forwardings (optional)
  when: enable_wireguard | bool
  loop: "{{ wg_forwardings | default([]) }}"
  community.openwrt.uci:
    command: set
    key: "firewall.fwd_{{ item.src }}_{{ item.dest }}"
    value:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
  notify: restart_firewall

- name: Remove deterministic WG ingress rules
  when: enable_wireguard | bool
  loop: "{{ wg_ingress_rules | default([]) }}"
  community.openwrt.uci:
    command: delete
    key: "firewall.wg_ingress_{{ item.name | lower | regex_replace('[^a-z0-9]+','_') }}"
  ignore_errors: true
  notify: restart_firewall

- name: Ensure WG ingress rule sections exist (type=rule)
  when: enable_wireguard | bool
  loop: "{{ wg_ingress_rules | default([]) }}"
  community.openwrt.uci:
    command: set
    key: "firewall.wg_ingress_{{ item.name | lower | regex_replace('[^a-z0-9]+','_') }}"
    value: "rule"
  notify: restart_firewall

- name: Create WG ingress rules (port-only)
  when: enable_wireguard | bool
  loop: "{{ wg_ingress_rules | default([]) }}"
  vars:
    rule_key: "wg_ingress_{{ item.name | lower | regex_replace('[^a-z0-9]+','_') }}"
  community.openwrt.uci:
    command: set
    key: "firewall.{{ rule_key }}"
    value:
      name: "{{ item.name }}"
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      proto: "{{ item.proto }}"
      dest_port: "{{ item.dest_port }}"
      target: "{{ item.target }}"
  notify: restart_firewall

# -------------------------
# Commit
# -------------------------
- name: Commit firewall
  community.openwrt.uci:
    command: commit
    config: firewall
  notify: restart_firewall
