---
- name: Restart network in background (router will come back with old+new IP)
  ansible.builtin.shell: "/etc/init.d/network restart >/dev/null 2>&1 &"
  async: 1
  poll: 0
  changed_when: true
  failed_when: false

- name: Wait for SSH on OLD mgmt IP (still available via alias)
  ansible.builtin.wait_for:
    host: "{{ openwrt_old_mgmt_ip }}"
    port: "{{ ssh_port }}"
    timeout: 240
    state: started
  delegate_to: localhost
  connection: local

- name: Wait for SSH on NEW mgmt IP (validation)
  ansible.builtin.wait_for:
    host: "{{ openwrt_new_mgmt_ip }}"
    port: "{{ ssh_port }}"
    timeout: 240
    state: started
  delegate_to: localhost
  connection: local

- name: Switch ansible_host to NEW mgmt IP (after it is reachable)
  ansible.builtin.set_fact:
    ansible_host: "{{ openwrt_new_mgmt_ip }}"
