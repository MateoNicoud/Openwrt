---
- name: Remove temporary mgmt alias interface (cleanup)
  when: enable_mgmt_alias_migration | bool
  community.openwrt.uci:
    command: delete
    key: "network.{{ mgmt_alias_section_name }}"
  ignore_errors: true
  notify: restart_network

- name: Commit network (after alias removal)
  when: enable_mgmt_alias_migration | bool
  community.openwrt.uci:
    command: commit
    config: network
  notify: restart_network

- name: Confirm success - cancel scheduled rollback job (atrm)
  when: enable_rollback_atd | bool
  ansible.builtin.shell: |
    set -e
    if [ -f "{{ rollback_dir }}/rollback_job_id" ]; then
      JOB_ID="$(cat "{{ rollback_dir }}/rollback_job_id" 2>/dev/null || true)"
      if [ -n "$JOB_ID" ]; then
        atrm "$JOB_ID" 2>/dev/null || true
      fi
      rm -f "{{ rollback_dir }}/rollback_job_id"
    fi
    rm -f "{{ rollback_dir }}/rollback_armed"
  args:
    executable: /bin/sh
  changed_when: false
