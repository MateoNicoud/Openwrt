---
- name: Sanity check - mgmt IP configured before restart
  ansible.builtin.shell: "ip -4 addr show | grep -q '{{ openwrt_new_mgmt_ip }}/' "
  changed_when: false

- name: Restart network now (expect brief disconnect)
  ansible.builtin.meta: flush_handlers

- name: Update ansible_host to new mgmt IP
  ansible.builtin.set_fact:
    ansible_host: "{{ openwrt_new_mgmt_ip }}"


- name: Verify SSH access with NEW rules
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: "{{ ssh_port }}"
    timeout: 180
    state: started
  delegate_to: localhost
  connection: local
